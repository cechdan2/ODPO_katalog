@{
    ViewData["Title"] = "Settings & Data";
}
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta name="theme-color" content="#16a34a">

<style>
    /* === GLOBAL VARS === */
    :root {
        --brand: #16a34a;
        --brand-dark: #166534;
        --border: #dbe7d9;
        --bg: #f4fbf4;
        --text: #0b1f0b;
        --white: #fff;
        --pad: 12px;
        --radius: 12px;
    }

    * {
        box-sizing: border-box;
    }

    body {
        margin: 0;
        padding: 0 0 100px 0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu;
        color: var(--text);
        background: var(--bg);
    }

    /* === HEADER === */
    header {
        position: sticky;
        top: 0;
        z-index: 5;
        background: #fff;
        border-bottom: 1px solid var(--border);
    }

    .container {
        max-width: 1100px;
        margin: 0 auto;
        padding: 14px var(--pad);
    }

    /* === CARDS / CONTAINERS === */
    .center-form-container {
        background: #fff;
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 2rem 2.2rem;
        margin: 0 auto 30px auto; /* Added spacing between cards */
        max-width: 800px;
        box-shadow: 0 2px 8px rgba(0,0,0,.04);
    }

    h2 {
        margin-top: 0;
        margin-bottom: 1.5rem;
        font-size: 1.4rem;
        color: var(--brand-dark);
        border-bottom: 2px solid #f0fdf4;
        padding-bottom: 10px;
    }

    /* === FORMS & BUTTONS === */
    .form-group {
        margin-bottom: 1rem;
    }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #333;
        }

    .btn-primary {
        background: var(--brand);
        color: #fff;
        padding: 0.7rem 1.2rem;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 500;
        cursor: pointer;
        transition: background 0.2s;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }

        .btn-primary:hover {
            background: var(--brand-dark);
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

    .btn-add {
        background: var(--brand);
        color: white;
        border: none;
        padding: 0 20px;
        border-radius: 0 8px 8px 0; /* Connected to input */
        cursor: pointer;
        font-weight: 600;
    }

        .btn-add:hover {
            background: var(--brand-dark);
        }

    /* === FILE INPUT STYLE === */
    .input-file-hidden {
        display: none;
    }

    .custom-file-label {
        background: #e0f2fe;
        color: #0284c7;
        border: 1px solid #7dd3fc;
        padding: 0.6rem 1.2rem;
        border-radius: 8px;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font-weight: 500;
    }

        .custom-file-label:hover {
            background: #bae6fd;
        }

    .custom-file-name {
        font-style: italic;
        color: #666;
        margin-left: 10px;
        font-size: 0.9rem;
    }

    /* === TABS FOR ATTRIBUTES === */
    .tabs {
        display: flex;
        gap: 5px;
        border-bottom: 1px solid var(--border);
        margin-bottom: 20px;
        overflow-x: auto;
        padding-bottom: 0;
    }

    .tab-btn {
        padding: 10px 16px;
        border: none;
        background: none;
        cursor: pointer;
        font-weight: 600;
        color: #666;
        border-radius: 8px 8px 0 0;
        white-space: nowrap;
        font-size: 0.95rem;
    }

        .tab-btn:hover {
            background: #f9f9f9;
            color: var(--brand);
        }

        .tab-btn.active {
            color: var(--brand-dark);
            background: #f0fdf4;
            border: 1px solid var(--border);
            border-bottom: 1px solid #fff; /* Blend with content */
            margin-bottom: -1px;
        }

    /* === ATTRIBUTE LIST === */
    .items-list {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 10px;
        min-height: 50px; /* Ensure visibility */
        max-height: 400px;
        overflow-y: auto;
        padding-right: 5px;
        margin-top: 15px;
    }

    .filter-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 12px;
        background: #fff;
        border: 1px solid var(--border);
        border-radius: 6px;
        font-size: 0.9rem;
    }

    .delete-btn {
        color: #ccc;
        cursor: pointer;
        font-weight: bold;
        font-size: 1.2rem;
        line-height: 1;
        padding: 0 4px;
        margin-left: 8px;
    }

        .delete-btn:hover {
            color: #ef4444;
        }

    /* === ADD ATTRIBUTE FORM === */
    .add-form {
        display: flex;
        margin-bottom: 10px;
    }

        .add-form input {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 8px 0 0 8px;
            font-size: 1rem;
            outline: none;
        }

            .add-form input:focus {
                border-color: var(--brand);
            }

    /* === FAB === */
    .fab-group {
        position: fixed;
        right: 20px;
        bottom: 20px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        z-index: 100;
    }

    .fab {
        width: 56px;
        height: 56px;
        background: var(--brand);
        color: #fff;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    /* Mobile adjustments */
    @@media (max-width: 600px) {
        .center-form-container {
            padding: 1.5rem;
            margin-top: 15px;
        }

        .items-list {
            grid-template-columns: 1fr 1fr;
        }
    }
</style>

<header>
    <div class="container" style="display:flex;align-items:center;gap:12px">
        <a href="@Url.Action("Index", "Photos")">
            <img src="@Url.Content("~/logo.png")" alt="Logo" style="height:48px;" />
        </a>
        <div>
            <h1 style="margin:0;font-size:18px;color:var(--brand);">Settings</h1>
            <div style="font-size:13px;color:#666;">Data & Attributes</div>
        </div>
    </div>
</header>

<main class="container">

    <!-- SEKCE 1: SPRÁVA ATRIBUTŮ (Filtry) -->
    <div class="center-form-container">
        <h2>Manage Attributes (Filters)</h2>

        <p style="font-size:0.9rem; color:#666; margin-bottom:15px;">
            Here you can add or remove options available in the catalog filters.
        </p>

        <!-- Tabs -->
        <div class="tabs" id="categoryTabs">
            <button class="tab-btn active" onclick="switchTab('supplier')">Suppliers</button>
            <button class="tab-btn" onclick="switchTab('material')">Materials</button>
            <button class="tab-btn" onclick="switchTab('color')">Colors</button>
            <button class="tab-btn" onclick="switchTab('form')">Forms</button>
            <button class="tab-btn" onclick="switchTab('filler')">Fillers</button>
            <button class="tab-btn" onclick="switchTab('position')">Positions</button>
        </div>

        <!-- Add Form -->
        <div class="add-form">
            <input type="text" id="newValueInput" placeholder="Type new value..." onkeypress="handleEnter(event)" />
            <button class="btn-add" onclick="addItem()">Add</button>
        </div>

        <!-- List -->
        <div id="loading" style="text-align:center; padding:10px; color:#999;">Loading...</div>
        <div id="listContainer" class="items-list"></div>
    </div>


    <!-- SEKCE 2: DATABÁZE & IMPORT -->
    <div class="center-form-container">
        <h2>Database Backup & Restore</h2>

        <div style="background:#e0f2fe; border:1px solid #bae6fd; color:#0369a1; padding:10px; border-radius:8px; margin-bottom:20px; font-size:0.9rem;">
            ℹ️ Backup contains the database and all images. Regular backups are recommended.
        </div>

        <!-- Download -->
        <div class="form-group">
            <label>1. Download Full Backup</label>
            <button id="downloadBtn" class="btn-primary" style="width:100%;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                Download ZIP
            </button>
        </div>

        <hr style="border:0; border-top:1px solid #eee; margin: 25px 0;">

        <!-- Restore -->
        <div class="form-group">
            <label>2. Restore from Backup</label>
            <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
                <input type="file" id="restoreFile" class="input-file-hidden" accept=".zip" onchange="updateFileName(this, 'restoreFile-name')" />
                <label for="restoreFile" class="custom-file-label">Choose ZIP...</label>
                <span id="restoreFile-name" class="custom-file-name">No file selected</span>
                <button id="restoreBtn" class="btn-primary" style="margin-left:auto; background:#0ea5e9;">Restore</button>
            </div>
            <div style="color:#ef4444; font-size:0.85rem; margin-top:5px;">⚠️ Overwrites current data!</div>
        </div>

        <hr style="border:0; border-top:1px solid #eee; margin: 25px 0;">

        <!-- Excel Import -->
        <div class="form-group">
            <label>3. Import from Excel</label>
            <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
                <input type="file" id="excelFile" class="input-file-hidden" accept=".xlsx,.xls" onchange="updateFileName(this, 'excelFile-name')" />
                <label for="excelFile" class="custom-file-label">Choose Excel...</label>
                <span id="excelFile-name" class="custom-file-name">No file selected</span>
                <button id="importBtn" class="btn-primary" style="margin-left:auto; background:#8b5cf6;">Import</button>
            </div>
        </div>
    </div>

</main>

<div class="fab-group">
    <a href="@Url.Action("Index", "Photos")" class="fab" title="Back to catalog">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M19 12H5"></path>
            <polyline points="12 19 5 12 12 5"></polyline>
        </svg>
    </a>
</div>

<!-- SCRIPTS -->
<script>
    // === ATTRIBUTE MANAGEMENT LOGIC ===
    let currentCategory = 'supplier';
    let allData = [];

    document.addEventListener('DOMContentLoaded', () => {
        loadData();
    });

    async function loadData() {
        const loading = document.getElementById('loading');
        loading.style.display = 'block';

        try {
            const res = await fetch('/api/filters');
            if(res.ok) {
                allData = await res.json();
                renderList();
            } else {
                console.error("API returned status:", res.status);
                document.getElementById('listContainer').innerHTML = `<div style="color:red; text-align:center;">Failed to load data (Status ${res.status}). <br>Did you add FilterOptionsController.cs?</div>`;
            }
        } catch (err) {
            console.error("Error loading filters", err);
            document.getElementById('listContainer').innerHTML = `<div style="color:red; text-align:center;">Error connecting to API.</div>`;
        } finally {
            loading.style.display = 'none';
        }
    }

    function switchTab(category) {
        currentCategory = category;
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');

        // Update placeholder
        document.getElementById('newValueInput').placeholder = `Add new ${category}...`;
        renderList();
    }

    function renderList() {
        const container = document.getElementById('listContainer');
        container.innerHTML = '';

        // Safely access properties handling CamelCase (js default) or PascalCase (C# default)
        const filtered = allData.filter(x => {
            const cat = x.category || x.Category || "";
            return cat.toLowerCase() === currentCategory.toLowerCase();
        });

        // Sort alphabetically
        filtered.sort((a,b) => {
            const valA = a.value || a.Value || "";
            const valB = b.value || b.Value || "";
            return valA.localeCompare(valB);
        });

        if (filtered.length === 0) {
            container.innerHTML = `<div style="grid-column: 1 / -1; text-align:center; color:#888; padding:20px; font-style:italic;">No items found for ${currentCategory}.</div>`;
            return;
        }

        filtered.forEach(item => {
            const val = item.value || item.Value;
            const id = item.id || item.Id;

            const div = document.createElement('div');
            div.className = 'filter-item';
            div.innerHTML = `
                <span>${val}</span>
                <span class="delete-btn" onclick="deleteItem(${id})">&times;</span>
            `;
            container.appendChild(div);
        });
    }

    async function addItem() {
        const input = document.getElementById('newValueInput');
        const val = input.value.trim();
        if (!val) return;

        // Optimistic UI update could be here, but we'll wait for server
        try {
            const res = await fetch('/api/filters', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                },
                body: JSON.stringify({ category: currentCategory, value: val })
            });

            if (res.ok) {
                const newItem = await res.json();
                allData.push(newItem);
                renderList();
                input.value = '';
            } else {
                alert("Failed to add item. It might already exist.");
            }
        } catch (err) {
            console.error(err);
            alert("Error adding item.");
        }
    }

    async function deleteItem(id) {
        if(!confirm("Are you sure you want to delete this option?")) return;

        try {
            const res = await fetch(`/api/filters/${id}`, {
                method: 'DELETE',
                headers: {
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                }
            });

            if (res.ok) {
                // Remove from local array handling both Id/id casing
                allData = allData.filter(x => (x.id || x.Id) !== id);
                renderList();
            } else {
                alert("Failed to delete item.");
            }
        } catch (err) {
            console.error(err);
        }
    }

    function handleEnter(e) {
        if (e.key === 'Enter') addItem();
    }


    // === DATABASE BACKUP & RESTORE LOGIC ===

    // Helper for file inputs
    function updateFileName(input, spanId) {
        const span = document.getElementById(spanId);
        if (input.files && input.files.length > 0) {
            span.textContent = input.files[0].name;
            span.style.color = "#333";
            span.style.fontStyle = "normal";
        } else {
            span.textContent = "No file selected";
        }
    }

    // Download
    document.getElementById('downloadBtn').addEventListener('click', async function() {
        const btn = this;
        btn.disabled = true;
        btn.innerHTML = '⏳ Preparing...';
        try {
            const resp = await fetch('/api/admin/db/backup');
            if (!resp.ok) throw new Error(await resp.text());
            const blob = await resp.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup-${new Date().toISOString().slice(0,10)}.zip`;
            document.body.appendChild(a);
            a.click();
            a.remove();
        } catch (err) {
            alert('Backup failed: ' + err.message);
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg> Download ZIP';
        }
    });

    // Restore
    document.getElementById('restoreBtn').addEventListener('click', async function() {
        const input = document.getElementById('restoreFile');
        if (!input.files[0]) return alert('Please select a ZIP file first.');
        if (!confirm('WARNING: This will overwrite the entire database and all photos! Continue?')) return;

        const btn = this;
        btn.disabled = true;
        btn.textContent = 'Restoring...';

        const fd = new FormData();
        fd.append('backupZip', input.files[0]);

        try {
            const resp = await fetch('/api/admin/db/restore', {
                method: 'POST',
                body: fd,
                headers: {
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                }
            });

            if (resp.ok) {
                alert('Database restored successfully!');
                window.location.reload();
            } else {
                throw new Error(await resp.text());
            }
        } catch (err) {
            alert('Restore failed: ' + err.message);
        } finally {
            btn.disabled = false;
            btn.textContent = 'Restore';
        }
    });

    // Import Excel
    document.getElementById('importBtn').addEventListener('click', async function() {
        const input = document.getElementById('excelFile');
        if (!input.files[0]) return alert('Please select an Excel file.');
        if (!confirm('Import data from Excel?')) return;

        const btn = this;
        btn.disabled = true;
        btn.textContent = 'Importing...';

        const fd = new FormData();
        fd.append('excelFile', input.files[0]);

        try {
            const resp = await fetch('@Url.Action("Import", "Photos")', { // Using Razor Url.Action
                method: 'POST',
                body: fd,
                headers: {
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                }
            });

            const data = await resp.json();
            if (data.success) {
                let msg = '✅ ' + data.message;
                if (data.warnings && data.warnings.length) msg += '\n\nWarnings:\n' + data.warnings.join('\n');
                alert(msg);
                window.location.href = '@Url.Action("Index", "Photos")';
            } else {
                alert('Import error: ' + data.message);
            }
        } catch (err) {
            alert('Import failed: ' + err.message);
        } finally {
            btn.disabled = false;
            btn.textContent = 'Import';
        }
    });
</script>

<!-- Anti-Forgery Token for Fetch API -->
@Html.AntiForgeryToken()